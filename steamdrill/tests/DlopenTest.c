#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>
#include <errno.h>
#include <unistd.h>

void print_usage()
{
  fprintf(stderr, "./DlopenTest <test_file>\n");
}



#define MAP_FILE "/proc/%d/maps"
int main(int argc, char **argv)
{
  char *filename = NULL;
  void *handle = NULL;
  char map_file[256];

  if (argc < 2)
  {
    fprintf(stderr, "I need an argument!\n");
    print_usage();
    return -EINVAL;
  }

  filename = argv[1];
  printf("testing %s\n", filename);

  // step one... dynamically load the dynamic loader?

  handle = dlopen(filename, RTLD_NOW);
  if (!handle)
  {
    printf("dlerror: %s\n", dlerror());
    return -EINVAL;
  }
  else
  {
    FILE *maps;
    char *line = NULL;
    size_t len = 0, read = 0;

    sprintf(map_file, MAP_FILE, getpid());
    maps = fopen(map_file, "r");
    while ((read = getline(&line, &len, maps)) != -1 )
    {
      printf("%s", line);
    }

    fclose(maps);
  }

  return 0;
}
